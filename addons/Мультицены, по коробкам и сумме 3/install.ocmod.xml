<modification>
  <name>Мультивалютные товары</name>
  <code>mcg2_admin.ocmod</code>
  <version>3</version>  
	<author>Folder Kotlyarov Sergey</author>
	<link>https://skillcode.ru</link>
  
<file path="admin/model/catalog/product.php">      
    <operation error="skip">
      <search><![CDATA[  	
          public function addProduct($data) {
          ]]></search>
      <add position="before">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  add poduct
          public function delProductMC($product_id) {
           		$this->db->query("DELETE FROM " . DB_PREFIX . "product_multycurr          WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_multycurr_special  WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_multycurr_discount WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_multycurr_option   WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_input_price        WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_ym              WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_supplier        WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_sliv               WHERE product_id = '" . (int)$product_id . "'");
          		$this->db->query("DELETE FROM " . DB_PREFIX . "product_country_of_origin  WHERE product_id = '" . (int)$product_id . "'");
            }
          public function saveProductMC($data,$product_id) {
              $this->delProductMC($product_id);
              if (isset($data['ym']))                                            $this->db->query("INSERT INTO " . DB_PREFIX . "product_to_ym             SET product_id = '" . (int)$product_id . "', ym = '1'");
              if (isset($data['sliv']))                                          $this->db->query("INSERT INTO " . DB_PREFIX . "product_sliv              SET product_id = '" . (int)$product_id . "', sliv = '1'");
              if (isset($data['supplier'])&&$data['supplier'])                   $this->db->query("INSERT INTO " . DB_PREFIX . "product_to_supplier       SET product_id = '" . (int)$product_id . "', supplier = '" . $this->db->escape($data['supplier']) . "'");
              if (isset($data['country_of_origin'])&&$data['country_of_origin']) $this->db->query("INSERT INTO " . DB_PREFIX . "product_country_of_origin SET product_id = '" . (int)$product_id . "', country = '" .  $this->db->escape($data['country_of_origin']) . "'");
              if (isset($data['price_curr'])&&$data['price_curr'])               $this->db->query("INSERT INTO " . DB_PREFIX . "product_multycurr         SET product_id = '" . (int)$product_id . "', price = '" .    (float)$data['price_curr'] . "', currency_id = '" . (int)$data['mc_currency_id'] . "'");
              if (isset($data['price_input'])&&$data['price_input'])             $this->db->query("INSERT INTO " . DB_PREFIX . "product_input_price       SET product_id = '" . (int)$product_id . "', iprice = '" .   (float)$data['price_input'] . "', currency_id = '" . (int)$data['input_currency_id'] . "'");
            }
            // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[  	
          $product_id = $this->db->getLastId();
          ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  add poduct
              $this->saveProductMC($data,$product_id);
            // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[  	
          $this->addProduct($data);
          ]]></search>
      <add position="before">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  copy poduct
               $mquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_multycurr WHERE product_id = '" . $product_id . "'");
               $data['price_curr']  = $mquery->row?$mquery->row['price']:''; 
               $data['mc_currency_id'] = $mquery->row?$mquery->row['currency_id']:'';
               $mquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_input_price WHERE product_id = '" . $product_id . "'");
               $data['price_input']  = $mquery->row?$mquery->row['price_input']:''; 
               $data['input_currency_id'] = $mquery->row?$mquery->row['currency_id']:'';
               $mquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_to_ym WHERE product_id = '" . $product_id . "'");
               if ($mquery->row) $data['ym']  = 1; 
               $mquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_to_supplier WHERE product_id = '" . $product_id . "'");
               $data['supplier']  = $mquery->row?$mquery->row['supplier']:''; 
               $mquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_sliv WHERE product_id = '" . $product_id . "'");
               if ($mquery->row) $data['sliv']  = 1; 
               $mquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_country_of_origin WHERE product_id = '" . $product_id . "'");
               $data['country_of_origin']  = $mquery->row?$mquery->row['country']:''; 
            // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[  	
          deleteProduct($product_id) {
          ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  delete poduct
              $this->delProductMC($product_id);
           // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[  	
          editProduct($product_id, $data) {
          ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  edit poduct
              $this->saveProductMC($data,$product_id);
           // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[  	
          $product_option_value_data[] = array(
          ]]></search>
      <add position="before">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  getProductOptions
               $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_multycurr_option WHERE product_option_value_id = '" . (int)$product_option_value['product_option_value_id'] . "'");
               $mc_price = ($mc_query->row?$mc_query->row['mc_price']:''); 
           // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[  	
          $product_option_value_data[] = array(
          ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 -  getProductOptions
             'mc_price' => $mc_price,
           // Module "MultyCurrency Products" v. 2.0 -  end
            ]]>
      </add>
    </operation>
	
<!-- admin/model/catalog/product.php: special price -->
    <operation error="skip">
      <search><![CDATA[
        $this->db->query("INSERT INTO " . DB_PREFIX . "product_special SET product_id
        ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - get special price from table
                $last_id = $this->db->getLastId(); 
               if ($product_special['mc_price']){$this->db->query("INSERT INTO " . DB_PREFIX . "product_multycurr_special SET product_special_id = '" . (int)$last_id . "', product_id = '" . (int)$product_id . "', mc_price = '" . (float)$product_special['mc_price'] . "', currency_id = '" . (int)$data['mc_currency_id'] . "'");}
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>        
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_special WHERE product_id = '" . (int)$product_id . "' ORDER BY priority, price");
        ]]></search>
      <add position="replace">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - get special price from table
            // $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_special WHERE product_id = '" . (int)$product_id . "' ORDER BY priority, price");
             $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_special p LEFT JOIN " . DB_PREFIX . "product_multycurr_special pd ON (p.product_special_id = pd.product_special_id) WHERE p.product_id = '" . (int)$product_id . "' ORDER BY priority, price");
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>
      </add>
    </operation>
	
<!-- admin/model/catalog/product.php: discount price -->
    <operation error="skip">
      <search><![CDATA[
        $this->db->query("INSERT INTO " . DB_PREFIX . "product_discount SET product_id = 
        ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - save discount price from table
             $last_id = $this->db->getLastId(); 
             if ($product_discount['mc_price']){$this->db->query("INSERT INTO " . DB_PREFIX . "product_multycurr_discount SET product_discount_id = '" . (int)$last_id . "', product_id = '" . (int)$product_id . "', mc_price = '" . (float)$product_discount['mc_price'] . "', currency_id = '" . (int)$data['mc_currency_id'] . "'");}
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>        
      </add>
    </operation>
	
    <operation error="skip">
      <search><![CDATA[
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_discount WHERE product_id = '" . (int)$product_id . "' ORDER BY quantity, priority, price");
      ]]></search>
      <add position="replace">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - get discount price to table
            // $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_discount WHERE product_id = '" . (int)$product_id . "' ORDER BY quantity, priority, price");
            $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_discount p LEFT JOIN " . DB_PREFIX . "product_multycurr_discount pd ON (p.product_discount_id = pd.product_discount_id) WHERE p.product_id = '" . (int)$product_id . "' ORDER BY priority, price");
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>
      </add>
    </operation>
<!-- admin/model/catalog/product.php: getProductOptions -->
  <operation error="skip">
      <search><![CDATA[
        $product_option_value_data[] = array(
        ]]></search>
      <add position="before">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - get option price from table
           $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_multycurr_option WHERE product_option_value_id = '" . (int)$product_option_value['product_option_value_id'] . "'");
           $mc_price = ($mc_query->row?$mc_query->row['mc_price']:''); 
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>
      </add>
  </operation>
   <operation error="skip">
      <search><![CDATA[$product_option_value_data[] = array(]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - add price to array
             'mc_price' => $mc_price,
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>
      </add>
    </operation>
<!-- admin/model/catalog/product.php: edit poduct - option price -->
    <operation error="skip">
      <search><![CDATA[
        $this->db->query("INSERT INTO " . DB_PREFIX . "product_option_value SET product_option_id = '" . (int)$product_option_id . "', product_id = '" . (int)$product_id . "', option_id = '" . (int)$product_option['option_id'] . "', option_value_id = '" . (int)$product_option_value['option_value_id'] . "', quantity = '" . (int)$product_option_value['quantity'] . "', subtract = '" . (int)$product_option_value['subtract'] . "', price = '" . (float)$product_option_value['price'] . "', price_prefix = '" . $this->db->escape($product_option_value['price_prefix']) . "', points = '" . (int)$product_option_value['points'] . "', points_prefix = '" . $this->db->escape($product_option_value['points_prefix']) . "', weight = '" . (float)$product_option_value['weight'] . "', weight_prefix = '" . $this->db->escape($product_option_value['weight_prefix']) . "'");
      ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - save option price to table
           $last_id = $this->db->getLastId(); 
           if ($product_option_value['mc_price'])$this->db->query("INSERT INTO " . DB_PREFIX . "product_multycurr_option SET product_option_value_id = '" . (int)$last_id . "', product_id = '" . (int)$product_id . "', mc_price = '" . (float)$product_option_value['mc_price'] . "', currency_id = '" . (int)$data['mc_currency_id'] . "'");
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>        
      </add>
  </operation>
    <operation error="skip">
      <search><![CDATA[
        $this->db->query("INSERT INTO " . DB_PREFIX . "product_option_value SET product_option_value_id = '" . (int)$product_option_value['product_option_value_id'] . "', product_option_id = '" . (int)$product_option_id . "', product_id = '" . (int)$product_id . "', option_id = '" . (int)$product_option['option_id'] . "', option_value_id = '" . (int)$product_option_value['option_value_id'] . "', quantity = '" . (int)$product_option_value['quantity'] . "', subtract = '" . (int)$product_option_value['subtract'] . "', price = '" . (float)$product_option_value['price'] . "', price_prefix = '" . $this->db->escape($product_option_value['price_prefix']) . "', points = '" . (int)$product_option_value['points'] . "', points_prefix = '" . $this->db->escape($product_option_value['points_prefix']) . "', weight = '" . (float)$product_option_value['weight'] . "', weight_prefix = '" . $this->db->escape($product_option_value['weight_prefix']) . "'");
      ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - save option price to table
           $last_id = $this->db->getLastId(); 
           if ($product_option_value['mc_price'])$this->db->query("INSERT INTO " . DB_PREFIX . "product_multycurr_option SET product_option_value_id = '" . (int)$last_id . "', product_id = '" . (int)$product_id . "', mc_price = '" . (float)$product_option_value['mc_price'] . "', currency_id = '" . (int)$data['mc_currency_id'] . "'");
            // Module "MultyCurrency Products" v. 2.0 - end
           ]]>        
      </add>
  </operation>
</file>

<file path="admin/controller/catalog/product.php">

	<operation error="skip">
          <search><![CDATA[
			$this->model_catalog_product->editProduct($this->request->get['product_id'], $this->request->post);
          ]]></search>
          <add position="before">
		  <![CDATA[
            $this->model_extension_multycurrgoods->set_custom_extra_charge_info($this->request->get['product_id'], $this->request->post);
			]]>
          </add>
        </operation>
	<operation error="skip">
          <search><![CDATA[
			public function edit() {
          ]]></search>
          <add position="after">
		  <![CDATA[
		  $this->load->model('extension/multycurrgoods');
			]]>
          </add>
    </operation>
	<operation error="skip">
          <search><![CDATA[
          $data['tab_openbay'] = $this->language->get('tab_openbay');
          ]]></search>
          <add position="after">
		  <![CDATA[
		  $this->load->model('extension/multycurrgoods');

        $info = $this->model_extension_multycurrgoods->get_extra_charge_info();
        $custom_info = $this->model_extension_multycurrgoods->get_custom_extra_charge_info($this->request->get['product_id']);
        $currency_info = $this->model_extension_multycurrgoods->get_setting_currency();

        $data['currency_info'] = $currency_info;
        $data['extra_charge'] = $info;
        $data['custom_extra_charge'] = $custom_info;
			]]>
          </add>
        </operation>
    <operation error="skip">
      <search><![CDATA[  	
                function getForm() {
               ]]></search>
      <add position="after">
           <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - loading settings and set default values
              $data['ym'] = '';
              $data['supplier'] = '';
              $data['sliv'] = '';
              $data['country_of_origin'] = '';
              $data['price_input'] = '';
              $data['price_input_currency_id'] = -1;

              $data['price_multycurr'] = '';
              $data['price_multycurr_currency_id'] = -1;
              $data['mc_prefix_def_code'] = $this->config->get('config_currency');
              $data['round_mode'] = 2;
              $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "setting WHERE `code` = 'multycurrgoods' AND `key` = 'round_mode'");
              if ($query->row) $data['round_mode'] = $query->row['value'];
              if (($data['round_mode']<-2)||($data['round_mode']>3)) $data['round_mode'] = 2;
            // Module "MultyCurrency Products" v. 1.6 - load currency list
              $data['mc_currencies'] = array();
              $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "currency" . " ORDER BY title");
              foreach ($query->rows as $result) {
              $data['mc_currencies'][] = array(
                 'currency_id'   => $result['currency_id'],
                 'title'         => $result['title'] . (($result['code'] == $this->config->get('config_currency')) ? ' (По умолчанию)' : null),
                 'code'          => $result['code'],
                 'value'         => $result['value']
                 );
              }
              // Module "MultyCurrency Products" v. 2.0 -  end
               ]]>
      </add>
    </operation>
    <operation error="skip">
      <search><![CDATA[
                                  $this->model_catalog_product->getProduct($this->request->get['product_id']);
                                ]]></search>
      <add position="before">
           <![CDATA[
              // Module "MultyCurrency Products" v. 2.0 - load data for template
                $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_multycurr WHERE product_id = '" . (int)$this->request->get['product_id'] . "'");
                if ($mc_query->row) {
                  $data['price_multycurr']              = $mc_query->row['price'];
                  $data['price_multycurr_currency_id']  = $mc_query->row['currency_id'];
                  }

                $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_input_price WHERE product_id = '" . (int)$this->request->get['product_id'] . "'");
                if ($mc_query->row) {
                  $data['price_input']              = $mc_query->row['iprice'];
                  $data['price_input_currency_id']  = $mc_query->row['currency_id'];
                  }

                $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_to_ym WHERE product_id = '" . (int)$this->request->get['product_id'] . "'");
                if ($mc_query->row) $data['ym']              = $mc_query->row['ym'];

                $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_to_supplier WHERE product_id = '" . (int)$this->request->get['product_id'] . "'");
                if ($mc_query->row) $data['supplier']        = $mc_query->row['supplier'];

                $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_sliv WHERE product_id = '" . (int)$this->request->get['product_id'] . "'");
                if ($mc_query->row) $data['sliv']            = $mc_query->row['sliv'];

                $mc_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_country_of_origin WHERE product_id = '" . (int)$this->request->get['product_id'] . "'");
                if ($mc_query->row) $data['country_of_origin'] = $mc_query->row['country'];
              // Module "MultyCurrency Products" v. 2.0 -  end
           ]]>
      </add>
    </operation>
    <operation error="skip">
      <search><![CDATA[$product_option_value_data[] = array(]]></search>
      <add position="after">
              <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - load option prices for template
              'mc_price' => $product_option_value['mc_price'],
            // Module "MultyCurrency Products" v. 2.0 -  end
              ]]>
      </add>
    </operation>
    <operation error="skip">
      <search><![CDATA[
        			$data['product_specials'][] = array(
        ]]></search>
      <add position="after">
              <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - load special prices for template
              'mc_price' => $product_special['mc_price'],
            // Module "MultyCurrency Products" v. 2.0 -  end
              ]]>
      </add>
    </operation>
    <operation error="skip">
      <search><![CDATA[
        			$data['product_discounts'][] = array(
        ]]></search>
      <add position="after">
              <![CDATA[
            // Module "MultyCurrency Products" v. 2.0 - load discount prices for template
              'mc_price' => $product_discount['mc_price'],
            // Module "MultyCurrency Products" v. 2.0 -  end
              ]]>
      </add>
    </operation>
</file>

<file path="admin/view/template/catalog/product_form.tpl">
  <operation error="skip">
  
    <search><![CDATA[<?php echo $footer; ?>]]></search>
    <add position="before"><![CDATA[  
      <script type="text/javascript"><!--
         var mc_prefix_def = '';
         var mc_prefix_sel = '';
         var mc_style     = '';
         // --------------------------------------------------------------------
         function intParser (data) {
           if (data== 'undefined') return 0;
           if (data== undefined)   return 0;
           var value = 0;
           var i = 0;
           while (i<data.length ) {
              var c = data[i];
              if ((c > '0') && (c <= '9')) break;
              i++; 
              }
           while (i<data.length) {
              var c = data[i];
              if ((c < '0') || (c > '9')) break; 
              value = value * 10 + (c-'0');
              i++;
              }
           return value;
           }
         // --------------------------------------------------------------------
        function selChangeCurr(dest_name, source_name){
          if(dest_name&&source_name) nameChangeCurr(dest_name, source_name);
          var objSel = document.getElementById('mc_currency_id');
          var value  = objSel.options[objSel.selectedIndex].dataset.title;
          mc_prefix_sel = '<input class="form-control mcg_prefix" style="width:50%;display:inline-block;" disabled type="text" name="mc_prefix_sel" value="' + value + '" />';
          $(".mcg_prefix").each(function(){ $(this).replaceWith (mc_prefix_sel); });
          if (objSel.options[objSel.selectedIndex].dataset.item==1) {
              $(".mcg_visible").css("display","none");
              mc_style    = ' style="display:none"';
              }
          else {
              $(".mcg_visible").css("display","block");
              mc_style    = ' style="display:block"';
              }
          }
         // --------------------------------------------------------------------
        function nameChangeCurr(dest_name, source_name){
          var dest_sel     = "input[name='" + dest_name + "']";
          var source_sel   = "input[name='" + source_name + "']";
          var objSel = document.getElementById('mc_currency_id');
          var value  = $(source_sel).val()/objSel.options[objSel.selectedIndex].dataset.item;
          <?php if (isset($round_mode)) { ?>
              <?php if ($round_mode==3)  { ?> value  = value.toFixed(3); <?php } ?>
              <?php if ($round_mode==2)  { ?> value  = value.toFixed(2); <?php } ?>
              <?php if ($round_mode==1)  { ?> value  = value.toFixed(1); <?php } ?>
              <?php if ($round_mode==0)  { ?> value  = value.toFixed(0); <?php } ?>
              <?php if ($round_mode==-1) { ?> value  = 10*(value/10).toFixed(0); <?php } ?>
              <?php if ($round_mode==-2) { ?> value  = 100*(value/100).toFixed(0); <?php } ?>
          <?php } ?>
          $(dest_sel).attr('value', value);
          }
      
      // JQuery modifications
      $(document).ready(function(){
          <?php foreach ($mc_currencies as $curr) { ?>
             <?php if ($curr['code']==$mc_prefix_def_code) { ?>
                  mc_prefix_def = '<input type="text" name="mc_prefix_def" disabled value="<?php echo $curr['title']; ?>" class="form-control" style="width:50%;display:inline-block;" />';
             <?php } ?>
             <?php if ((($curr['value']==1)&&($price_multycurr_currency_id==-1))||($price_multycurr_currency_id==$curr['currency_id'])) { ?> 
                  mc_prefix_sel = '<input disabled type="text" name="mc_prefix_sel" value="<?php echo $curr['title']; ?>" class="form-control mcg_prefix" style="width:50%;display:inline-block;" />';
             <?php } ?>
          <?php } ?>
          var add_to_price  = '';
          var iPrice = $('input[name=\'price\']');
          // Модификация цены
          iPrice.css('width', '50%');
          iPrice.css('display', 'inline-block');
          iPrice.after(mc_prefix_def); 
          // Добавляем поле "Страна происхождения товара"
          add_to_price  = '<div class="form-group"><label class="col-sm-2 control-label" for="input-country_of_origin">Страна происхождения товара</label><div class="col-sm-10">';
          add_to_price += '<input type="text" name="country_of_origin" value="<?php echo addslashes($country_of_origin); ?>" placeholder="Страна происхождения товара" class="form-control" />';
          add_to_price += '</div></div>';
          iPrice.parent().parent().after(add_to_price);   
          // Добавляем поле "Поставщик товара"
          add_to_price  = '<div class="form-group"><label class="col-sm-2 control-label" for="input-supplier">Поставщик товара</label><div class="col-sm-10">';
          add_to_price += '<input type="text" name="supplier" value="<?php echo addslashes($supplier); ?>" placeholder="Поставщик товара" class="form-control" />';
          add_to_price += '</div></div>';
          iPrice.parent().parent().after(add_to_price);   
          // Добавляем поле "Слив товара"
          add_to_price  = '<div class="form-group"><label class="col-sm-2 control-label" for="input-sliv">Слив товара</label><div class="col-sm-10">';
          add_to_price += '<input type="checkbox" style="display:inline-block;" name="sliv" value="1" <?php if (isset($sliv)&&$sliv==1) { ?>checked="checked"<?php } ?>  placeholder="Слив товара" class="form-control" />&nbsp;&nbsp;разрешена продажа товара ниже РРЦ';
          add_to_price += '</div></div>';
          iPrice.parent().parent().after(add_to_price);   
          // Добавляем поле "Яндекс.Маркет"
          add_to_price  = '<div class="form-group"><label class="col-sm-2 control-label" for="input-ym">Яндекс.Маркет</label><div class="col-sm-10">';
          add_to_price += '<input type="checkbox" style="display:inline-block;" name="ym" value="1" <?php if (isset($ym)&&$ym==1) { ?>checked="checked"<?php } ?>  placeholder="Яндекс.Маркет" class="form-control" />&nbsp;&nbsp;разрешена выгрузка товара в Яндекс.Маркет';
          add_to_price += '</div></div>';
          iPrice.parent().parent().after(add_to_price);   
          // Добавляем поле "Валютная цена"
          add_to_price  = '<div class="form-group"><label class="col-sm-2 control-label" for="input-price_curr">Валютная цена</label><div class="col-sm-10">';
          add_to_price += '<input type="text" onchange="nameChangeCurr(\'price\', \'price_curr\');" name="price_curr" value="<?php echo $price_multycurr; ?>" placeholder="Валютная цена" class="form-control" style="width:50%;display:inline-block;" />';
          add_to_price += '<select id="mc_currency_id" name="mc_currency_id" onchange="selChangeCurr(\'price\', \'price_curr\');" class="form-control" style="width:50%;display:inline-block;">';
         <?php foreach ($mc_currencies as $curr) { ?>
             add_to_price += '<option data-item="<?php echo $curr['value']; ?>" data-title="<?php echo $curr['title']; ?>" <?php if ((($curr['value']==1)&&($price_multycurr_currency_id==-1))||($price_multycurr_currency_id==$curr['currency_id'])) { ?> selected="selected" <?php } ?> value="<?php echo $curr['currency_id']; ?>"><?php echo $curr['title']; ?></option>';
         <?php } ?>
          add_to_price += '</select></div></div>';
          iPrice.parent().parent().after(add_to_price);   
          // JQuery modifications for special price
          <?php $special_row = 0; foreach ($product_specials as $product_special) { ?>
            addToSpecials (<?php echo $special_row; ?>,"<?php echo $product_special['mc_price']; ?>");
          <?php $special_row ++; } ?>
          // JQuery modifications for discount price
          <?php $discount_row = 0; foreach ($product_discounts as $product_discount) { ?>
                addToDiscounts (<?php echo $discount_row; ?>,"<?php echo $product_discount['mc_price']; ?>");
          <?php $discount_row ++; } ?>
          // JQuery modifications for option price
          <?php $option_row = 0; $option_value_row = 0; ?>
          <?php foreach ($product_options as $product_option) { ?>
            <?php if( isset($product_option['product_option_value'])) { ?>
              <?php foreach ($product_option['product_option_value'] as $product_option_value) { ?>
                addToOptions (<?php echo $option_row; ?>,<?php echo $option_value_row; ?>,"<?php echo $product_option_value['mc_price']; ?>");
              <?php $option_value_row ++; } ?>
            <?php } ?>
          <?php $option_row++; } ?>
          // Инициализация режима скрытия\отображения
          selChangeCurr('', ''); 
 
      });
// JQuery modifications for special price
function addToSpecials (special_row,in_value) {
  var value = ''; if (typeof in_value != 'undefined') value = in_value;
  $('input[name*=\'product_special[' + special_row + ']\']').each(function(){
      if ($(this).attr('name').indexOf('price') + 1) {
        $(this).css('width', '50%');
        $(this).css('display', 'inline-block');
        $(this).after (('<div ' + mc_style + 'class="mcg_visible"><br /><input type="text" placeholder="Валютная цена" class="form-control" style="width:50%;display:inline-block;" name="product_special[' + special_row +'][mc_price]" value="' + value + '" onchange="nameChangeCurr(\'product_special[' + special_row +'][price]\',\'product_special[' + special_row +'][mc_price]\');" />'+mc_prefix_sel+'</div>')); 
        $(this).after(mc_prefix_def);
        }
      });  }
// JQuery modifications for discount price
function addToDiscounts (discount_row,in_value) {
  var value = ''; if (typeof in_value != 'undefined') value = in_value;
  $('input[name*=\'product_discount[' + discount_row + ']\']').each(function(){
      if ($(this).attr('name').indexOf('price') + 1) {
        $(this).css('width', '50%');
        $(this).css('display', 'inline-block');
        $(this).after (('<div ' + mc_style + 'class="mcg_visible"><br /><input type="text" placeholder="Валютная цена" class="form-control" style="width:50%;display:inline-block;" name="product_discount[' + discount_row +'][mc_price]" value="' + value + '" onchange="nameChangeCurr(\'product_discount[' + discount_row +'][price]\',\'product_discount[' + discount_row +'][mc_price]\');" />'+mc_prefix_sel+'</div>'));       
        $(this).after(mc_prefix_def);
        }
      });  }
// JQuery modifications for option price
function addToOptions (option_row,option_value_row,in_value) {
  var value = ''; if (typeof in_value != 'undefined') value = in_value;
  $('select[name*=\'product_option[' + option_row + '][product_option_value][' + option_value_row + '][price_prefix]\']').each(function(){
      if ($(this).attr('name').indexOf('price_prefix') + 1) {
        $(this).css('width', '19%');
        $(this).css('display', 'inline-block');
        $(this).next().css('width', '30%');
        $(this).next().css('display', 'inline-block');
        $(this).next().after (('<div ' + mc_style + 'class="mcg_visible"><br /><input type="text" placeholder="Валютная цена" class="form-control" style="width:50%;display:inline-block;" name="product_option[' + option_row +'][product_option_value][' + option_value_row + '][mc_price]" value="' + value + '" onchange="nameChangeCurr(\'product_option[' + option_row + '][product_option_value][' + option_value_row + '][price]\',\'product_option[' + option_row + '][product_option_value][' + option_value_row + '][mc_price]\');" />'+mc_prefix_sel+'</div>')); 
        $(this).next().after(mc_prefix_def);
        }
      });  }
// Перехват событий
$(document).ready(function(){ 
  $( document ).on( "click", ".btn-primary", function() {
    if ($(this).attr('onclick')!=undefined) {
        if ($(this).attr('onclick')=="addDiscount();")                addToDiscounts  (discount_row-1);
        if ($(this).attr('onclick')=="addSpecial();")                 addToSpecials   (special_row-1);
        if ($(this).attr('onclick').indexOf('addOptionValue') + 1 )   addToOptions(intParser ( $(this).attr('onclick') ),option_value_row-1); 
        }
    });
  });
    //--></script> 
    ]]></add>
  </operation> 

	<operation error="skip">
          <search><![CDATA[
          <label class="col-sm-2 control-label" for="input-tax-class"><?php echo $entry_tax_class; ?></label>
          ]]></search>
          <add position="before" offset="1">
		  <![CDATA[
		  <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-boxing"><span data-toggle="tooltip" title="Количество товара в упаковке. Или рекомендуемое для продажи количество.">Количество товара в упаковке</span></label>
                    <div class="col-sm-10">
                        <input type="text" name="boxing" value="<?php if(isset($custom_extra_charge['count_in_pack'])){echo $custom_extra_charge['count_in_pack'];} else{ echo '';}?>" placeholder="Введите количество" id="input-boxing" class="form-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-iprice">Закупочная цена</label>
                    <div class="col-sm-10">
                        <input type="text" name="price_input" value="<?php echo $price_input; ?>" placeholder="Закупочная цена" id="input-iprice" class="form-control" style="width:50%;display:inline-block; float: left;" />
                        <select class="form-control" style="width:50%;display:inline-block;" id="input_currency_id" name="input_currency_id">
                            <?php foreach ($mc_currencies as $curr) { ?>
                                add_to_price += '<option <?php if ((($curr['value']==1)&&($price_input_currency_id==-1))||($price_input_currency_id==$curr['currency_id'])) { ?> selected="selected" <?php } ?> value="<?php echo $curr['currency_id']; ?>"><?php echo $curr['title']; ?></option>';
                            <?php } ?>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-tax-class">
                        Цена одной единицы товара в зависимости от общей суммы покупки, и от количества покупки данного товара
                    </label>
                    <div class="col-sm-10">

                        <table class="table table-striped table-bordered table-hover">
                          <tr>
                            <th>Сумма покупки</th>
                            <th>до <?php echo $extra_charge['price_to'] .' '. $currency_info['value']; ?></th>
                            <th><?php echo $extra_charge['price_min'] .' - '. $extra_charge['price_max'] .' '. $currency_info['value'];  ?></th>
                            <th><?php echo $extra_charge['price_max'].'+ '. $currency_info['value'] ?></th>
                          </tr>
                          <tr>
                            <td>Мин.кол.</td>
                            <td>
                              <div class="input-group" style="width: 50%; float: left;">
                                <span class="input-group-addon">+</span>
                                <input class="form-control" id="sp_to" name="sp_to" value="<?php if(isset($custom_extra_charge['sp_to'])){echo $custom_extra_charge['sp_to'];} else{echo $extra_charge['sp_to'];} ?>" placeholder="Цена" type="text">
                                <span class="input-group-addon">%</span>
                              </div>
                              <input id="sp_to_res" class="form-control" name="sp_to_res_price" value="<?php if(isset($custom_extra_charge['sp_to_res_price'])){echo $custom_extra_charge['sp_to_res_price'].' '. $currency_info['value'];} else{echo '0'.' '. $currency_info['value'];} ?>" style="width:50%" type="text">
                            </td>
                            <td>
                              <div class="input-group" style="width: 50%; float: left;">
                                <span class="input-group-addon">+</span>
                                <input class="form-control" id="sp_min_max" name="sp_min_max" value="<?php if(isset($custom_extra_charge['sp_min_max'])){echo $custom_extra_charge['sp_min_max'];} else{echo $extra_charge['sp_min_max'];} ?>" placeholder="Цена" type="text">
                                <span class="input-group-addon">%</span>
                              </div>
                              <input id="sp_min_max_res" class="form-control" name="sp_min_max_res_price" value="<?php if(isset($custom_extra_charge['sp_min_max_res_price'])){echo $custom_extra_charge['sp_min_max_res_price'].' '. $currency_info['value'];} else{echo '0'.' '. $currency_info['value'];} ?>" style="width:50%" type="text">
                            </td>
                            <td>
                              <div class="input-group" style="width: 50%; float: left;">
                                <span class="input-group-addon">+</span>
                                <input class="form-control" id="sp_from" name="sp_from" value="<?php if(isset($custom_extra_charge['sp_from'])){echo $custom_extra_charge['sp_from'];} else{echo $extra_charge['sp_from'];} ?>" placeholder="Цена" type="text">
                                <span class="input-group-addon">%</span>
                              </div>
                              <input id="sp_from_res" class="form-control" name="sp_from_res_price" value="<?php if(isset($custom_extra_charge['sp_from_res_price'])){echo $custom_extra_charge['sp_from_res_price'].' '. $currency_info['value'];} else{echo '0'.' '. $currency_info['value'];} ?>" style="width:50%" type="text">
                            </td>
                          </tr>
                          <tr>
                            <td>Упаковка</td>
                            <td>
                              <div class="input-group" style="width: 50%; float: left;">
                                <span class="input-group-addon">+</span>
                                <input class="form-control" id="pop_to" name="pop_to" value="<?php if(isset($custom_extra_charge['pop_to'])){echo $custom_extra_charge['pop_to'];} else{echo $extra_charge['pop_to'];} ?>" placeholder="Цена" type="text">
                                <span class="input-group-addon">%</span>
                              </div>
                              <input id="pop_to_res" class="form-control" name="pop_to_res_price" value="<?php if(isset($custom_extra_charge['pop_to_res_price'])){echo $custom_extra_charge['pop_to_res_price'].' '. $currency_info['value'];} else{echo '0'.' '. $currency_info['value'];} ?>" style="width:50%" type="text">
                            </td>
                            <td>
                              <div class="input-group" style="width: 50%; float: left;">
                                <span class="input-group-addon">+</span>
                                <input class="form-control" id="pop_min_max" name="pop_min_max" value="<?php if(isset($custom_extra_charge['pop_min_max'])){echo $custom_extra_charge['pop_min_max'];} else{echo $extra_charge['pop_min_max'];} ?>" placeholder="Цена" type="text">
                                <span class="input-group-addon">%</span>
                              </div>
                              <input id="pop_min_max_res" class="form-control" name="pop_min_max_res_price" value="<?php if(isset($custom_extra_charge['pop_min_max_res_price'])){echo $custom_extra_charge['pop_min_max_res_price'].' '. $currency_info['value'];} else{echo '0'.' '. $currency_info['value'];} ?>" style="width:50%" type="text">
                            </td>
                            <td>
                              <div class="input-group" style="width: 50%; float: left;">
                                <span class="input-group-addon">+</span>
                                <input class="form-control" id="pop_from" name="pop_from" value="<?php if(isset($custom_extra_charge['pop_from'])){echo $custom_extra_charge['pop_from'];} else{echo $extra_charge['pop_from'];} ?>" placeholder="Цена" type="text">
                                <span class="input-group-addon">%</span>
                              </div>
                              <input id="pop_from_res" class="form-control" name="pop_from_res_price" value="<?php if(isset($custom_extra_charge['pop_from_res_price'])){echo $custom_extra_charge['pop_from_res_price'].' '. $currency_info['value'];} else{echo '0'.' '. $currency_info['value'];} ?>" style="width:50%" type="text">
                            </td>
                          </tr>
                        </table>
                      <div class="custum-send-ajax-btn" id="calculate_ajax" data-toggle="tooltip" title="" data-original-title="Пересчитать">
                        <span class="recount-text"><i class="fa fa-refresh fa-spin fa-3x fa-fw custom-hidden-recount-icon"></i>Пересчитать</span>
                      </div>
                    </div>
                </div>
			]]>
          </add>
        </operation> 
  
</file>
  
  
<file path="admin/view/template/common/header.tpl">          
        <operation error="skip">
          <search><![CDATA[
          </head>
          ]]></search>
          <add position="before">
		  <![CDATA[
          <link type="text/css" href="view/stylesheet/multycurrgoods.css" rel="stylesheet" media="screen" />
          ]]>
          </add>
        </operation> 
    </file>
	
	<file path="admin/view/template/common/footer.tpl">          
                
        <operation error="skip">
          <search><![CDATA[
          </body></html>
          ]]></search>
          <add position="before">
		  <![CDATA[
        <script type="text/javascript">
    function rewrite(arg) {

        var $sp_to_res = arg.sp_to_res;
        var $sp_min_max_res = arg.sp_min_max_res;
        var $sp_from_res = arg.sp_from_res;
        var $pop_to_res = arg.pop_to_res;
        var $pop_min_max_res = arg.pop_min_max_res;
        var $pop_from_res = arg.pop_from_res;

        function replaceValue() {
          $('#sp_to_res').attr('value', $sp_to_res);
          $("#sp_min_max_res").attr('value', $sp_min_max_res);
          $("#sp_from_res").attr('value', $sp_from_res);
          $("#pop_to_res").attr('value', $pop_to_res);
          $("#pop_min_max_res").attr('value', $pop_min_max_res);
          $("#pop_from_res").attr('value', $pop_from_res);
        }
        replaceValue();
    }

    $('#calculate_ajax').on('click', function () {

      var toStr = String(location);
      var res = toStr.split("/admin");
      var fin_url_array = res.splice(0, 1);
      var finUrl = (fin_url_array + '/index.php?route=extension/module/multycurrgoods/calculate_ajax');

      function send_ajax(){


        var sp_to = $("#sp_to").val();
        var sp_min_max = $("#sp_min_max").val();
        var sp_from = $("#sp_from").val();
        var pop_to = $("#pop_to").val();
        var pop_min_max = $("#pop_min_max").val();
        var pop_from = $("#pop_from").val();
        var input_iprice = $("#input-iprice").val();
        var input_currency_id = $("#input_currency_id").val();

        var send_info = {
          sp_to: sp_to,
          sp_min_max: sp_min_max,
          sp_from: sp_from,
          pop_to: pop_to,
          pop_min_max: pop_min_max,
          pop_from: pop_from,
          input_iprice: input_iprice,
          input_currency_id: input_currency_id
        };
		
        $.ajax({
          url: finUrl,
          type: 'post',
          data: send_info,
          dataType: 'json',
          cache: false,
          beforeSend: function( ) {
            $('.recount-text .custom-hidden-recount-icon').removeClass('custom-hidden-recount-icon').addClass('custom-visible-recount-icon');
          },
          success: function(json) {

            rewrite(json);
            $('.recount-text .custom-visible-recount-icon').removeClass('custom-visible-recount-icon').addClass('custom-hidden-recount-icon');
          }
        });
      }
	  send_ajax();
    });
</script>
		]]>
         </add>
        </operation> 
	</file>
    
	
	</modification>